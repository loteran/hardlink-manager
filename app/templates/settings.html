<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <title>R√©glages - HardLink Manager</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîó</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 30px; }
        h1 { color: #667eea; margin-bottom: 20px; text-align: center; }
        h2 { color: #495057; margin-bottom: 15px; font-size: 1.2em; }
        .section { margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .file-browser { border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; background: white; max-height: 250px; overflow-y: auto; }
        .file-item { padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; }
        .file-item:hover { background: #e9ecef; transform: translateX(5px); }
        .file-item.selected { background: #667eea; color: white; }
        .file-icon { margin-right: 10px; font-size: 1.2em; }
        .breadcrumb { padding: 10px; background: #e9ecef; border-radius: 5px; margin-bottom: 10px; font-family: monospace; word-break: break-all; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.3s; font-weight: bold; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; padding: 5px 10px; font-size: 0.9em; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-link { background: transparent; color: #667eea; border: 2px solid #667eea; text-decoration: none; display: inline-block; }
        .path-list { list-style: none; margin: 10px 0; }
        .path-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border: 1px solid #dee2e6; border-radius: 5px; margin: 5px 0; font-family: monospace; }
        .message { padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .button-row { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .buttons-footer { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .selected-path { padding: 12px; background: #e7f3ff; border: 2px solid #667eea; border-radius: 8px; font-family: monospace; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>R√©glages</h1>
        <div id="message" class="message"></div>

        <!-- Section R√©pertoires de base -->
        <div class="section">
            <h2>R√©pertoires accessibles</h2>
            <p style="color: #6c757d; margin-bottom: 10px;">Ces r√©pertoires seront disponibles dans l'explorateur de la page principale.</p>

            <div class="breadcrumb" id="basePathBreadcrumb">/</div>
            <div class="file-browser" id="basePathBrowser">
                <p>Chargement...</p>
            </div>
            <div class="button-row">
                <button class="btn btn-success" onclick="addToBasePaths()">+ Ajouter ce r√©pertoire</button>
            </div>

            <h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 1em; color: #495057;">R√©pertoires configur√©s :</h3>
            <ul class="path-list" id="basePathsList"></ul>
        </div>

        <!-- Section Destination par d√©faut -->
        <div class="section">
            <h2>Destination par d√©faut</h2>
            <p style="color: #6c757d; margin-bottom: 10px;">Ce r√©pertoire sera pr√©-s√©lectionn√© comme destination pour les hard links.</p>

            <div class="breadcrumb" id="destPathBreadcrumb">/</div>
            <div class="file-browser" id="destPathBrowser">
                <p>Chargement...</p>
            </div>
            <div class="button-row">
                <button class="btn btn-primary" onclick="setAsDefaultDest()">S√©lectionner ce r√©pertoire</button>
            </div>

            <div class="selected-path" id="selectedDestPath">
                <strong>Destination actuelle :</strong> <span id="destPathDisplay">{{ default_dest }}</span>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="buttons-footer">
            <button class="btn btn-primary" onclick="saveSettings()">Enregistrer</button>
            <a class="btn btn-link" id="backLink" href="./">Retour</a>
        </div>
    </div>

    <script>
        const basePath = window.location.pathname.replace(/\/settings\/?$/, '');
        document.getElementById('backLink').href = basePath + '/';

        let currentBasePathBrowse = '/';
        let currentDestPathBrowse = '/';
        let basePaths = {{ base_paths | tojson }};
        let defaultDest = '{{ default_dest }}';

        // Afficher la liste des r√©pertoires
        function renderBasePaths() {
            const list = document.getElementById('basePathsList');
            list.innerHTML = '';
            if (basePaths.length === 0) {
                list.innerHTML = '<li style="color: #6c757d; border: none;">Aucun r√©pertoire configur√©</li>';
                return;
            }
            basePaths.forEach((path, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${path}</span><button class="btn btn-danger" onclick="removePath(${index})">Supprimer</button>`;
                list.appendChild(li);
            });
        }

        // Charger un r√©pertoire dans l'explorateur des r√©pertoires de base
        async function loadBasePathDirectory(path) {
            try {
                const response = await fetch(`${basePath}/api/browse_all?path=${encodeURIComponent(path)}`);
                const items = await response.json();

                const browser = document.getElementById('basePathBrowser');
                browser.innerHTML = '';

                if (path !== '/') {
                    const parentItem = document.createElement('div');
                    parentItem.className = 'file-item';
                    parentItem.innerHTML = '<span class="file-icon">‚¨ÜÔ∏è</span> .. (Dossier parent)';
                    parentItem.onclick = () => {
                        const parentPath = path.split('/').slice(0, -1).join('/') || '/';
                        loadBasePathDirectory(parentPath);
                    };
                    browser.appendChild(parentItem);
                }

                if (items.length === 0 && path === '/') {
                    const shortcuts = ['/mnt', '/home', '/media'];
                    shortcuts.forEach(shortcut => {
                        const item = document.createElement('div');
                        item.className = 'file-item';
                        item.innerHTML = `<span class="file-icon">üìÅ</span> ${shortcut}`;
                        item.onclick = () => loadBasePathDirectory(shortcut);
                        browser.appendChild(item);
                    });
                }

                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'file-item';
                    itemDiv.innerHTML = `<span class="file-icon">üìÅ</span> ${item.name}`;
                    itemDiv.onclick = () => loadBasePathDirectory(item.path);
                    browser.appendChild(itemDiv);
                });

                currentBasePathBrowse = path;
                document.getElementById('basePathBreadcrumb').textContent = path;

            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur lors du chargement du r√©pertoire', 'error');
            }
        }

        // Charger un r√©pertoire dans l'explorateur de destination
        async function loadDestPathDirectory(path) {
            try {
                const response = await fetch(`${basePath}/api/browse_all?path=${encodeURIComponent(path)}`);
                const items = await response.json();

                const browser = document.getElementById('destPathBrowser');
                browser.innerHTML = '';

                if (path !== '/') {
                    const parentItem = document.createElement('div');
                    parentItem.className = 'file-item';
                    parentItem.innerHTML = '<span class="file-icon">‚¨ÜÔ∏è</span> .. (Dossier parent)';
                    parentItem.onclick = () => {
                        const parentPath = path.split('/').slice(0, -1).join('/') || '/';
                        loadDestPathDirectory(parentPath);
                    };
                    browser.appendChild(parentItem);
                }

                if (items.length === 0 && path === '/') {
                    const shortcuts = ['/mnt', '/home', '/media'];
                    shortcuts.forEach(shortcut => {
                        const item = document.createElement('div');
                        item.className = 'file-item';
                        item.innerHTML = `<span class="file-icon">üìÅ</span> ${shortcut}`;
                        item.onclick = () => loadDestPathDirectory(shortcut);
                        browser.appendChild(item);
                    });
                }

                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'file-item';
                    itemDiv.innerHTML = `<span class="file-icon">üìÅ</span> ${item.name}`;
                    itemDiv.onclick = () => loadDestPathDirectory(item.path);
                    browser.appendChild(itemDiv);
                });

                currentDestPathBrowse = path;
                document.getElementById('destPathBreadcrumb').textContent = path;

            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur lors du chargement du r√©pertoire', 'error');
            }
        }

        // Ajouter le chemin actuel aux r√©pertoires de base
        function addToBasePaths() {
            if (currentBasePathBrowse === '/') {
                showMessage('Veuillez s√©lectionner un r√©pertoire valide', 'error');
                return;
            }
            if (basePaths.includes(currentBasePathBrowse)) {
                showMessage('Ce r√©pertoire est d√©j√† dans la liste', 'error');
                return;
            }
            basePaths.push(currentBasePathBrowse);
            renderBasePaths();
            showMessage(`R√©pertoire ajout√©: ${currentBasePathBrowse}`, 'success');
        }

        // D√©finir comme destination par d√©faut
        function setAsDefaultDest() {
            if (currentDestPathBrowse === '/') {
                showMessage('Veuillez s√©lectionner un r√©pertoire valide', 'error');
                return;
            }
            defaultDest = currentDestPathBrowse;
            document.getElementById('destPathDisplay').textContent = defaultDest;
            showMessage(`Destination par d√©faut d√©finie: ${defaultDest}`, 'success');
        }

        // Supprimer un chemin
        function removePath(index) {
            basePaths.splice(index, 1);
            renderBasePaths();
        }

        // Enregistrer les param√®tres
        async function saveSettings() {
            const formData = new FormData();
            formData.append('base_paths', basePaths.join('\n'));
            formData.append('default_dest', defaultDest);

            try {
                const response = await fetch(basePath + '/settings', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    showMessage('Param√®tres enregistr√©s avec succ√®s!', 'success');
                } else {
                    showMessage('Erreur lors de l\'enregistrement', 'error');
                }
            } catch (err) {
                showMessage('Erreur: ' + err.message, 'error');
            }
        }

        // Afficher un message
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = (type === 'success' ? '‚úÖ ' : '‚ùå ') + text;
            msg.className = `message ${type}`;
            setTimeout(() => { msg.style.display = 'none'; }, 4000);
        }

        // Initialisation
        renderBasePaths();
        loadBasePathDirectory('/');
        loadDestPathDirectory('/');
    </script>
</body>
</html>
