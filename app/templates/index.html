<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HardLink Manager</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîó</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h2 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .file-browser {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: white;
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .file-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .file-item.selected {
            background: #667eea;
            color: white;
        }

        .file-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #dee2e6;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .breadcrumb {
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <h1>üîó HardLink Manager</h1>
            <a href="#" id="settingsLink" class="btn btn-primary" style="padding:8px 12px">‚öôÔ∏è R√©glages</a>
        </div>

        <div class="info-box">
            <strong>‚ÑπÔ∏è Info:</strong> Les hard links ne fonctionnent que sur le m√™me syst√®me de fichiers (m√™me disque).
        </div>

        <div class="section">
            <h2>üìÅ 1. S√©lectionner les sources</h2>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <div class="breadcrumb" id="sourcePath" style="flex: 1; margin-bottom: 0;">Parcourir...</div>
                <button class="btn btn-primary" onclick="selectAllVisible()" style="padding: 8px 15px; font-size: 0.9em; background: #17a2b8;">
                    ‚òëÔ∏è Tout s√©lectionner
                </button>
                <button class="btn btn-primary" onclick="clearSelection()" style="padding: 8px 15px; font-size: 0.9em; background: #6c757d;">
                    ‚úñÔ∏è Effacer
                </button>
            </div>
            <div class="file-browser" id="sourceBrowser">
                <p>Chargement...</p>
            </div>
                        <div id="selectionSummary" style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 5px; display: none;">
                <strong>S√©lection :</strong> <span id="selectionCount">0</span> √©l√©ment(s)
                <div id="selectionList" style="margin-top: 5px; font-size: 0.85em; color: #495057; max-height: 80px; overflow-y: auto;"></div>
            </div>
            <p style="margin-top: 10px; color: #6c757d; font-size: 0.9em;">
                üí° Cochez les fichiers et/ou dossiers √† traiter. Double-cliquez sur un dossier pour y entrer.
            </p>
        </div>

        <div class="section">
            <h2>üìÇ 2. Destination du hard link</h2>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <div class="breadcrumb" id="destPath" style="flex: 1; margin-bottom: 0;">Parcourir...</div>
                <button class="btn btn-primary" onclick="selectCurrentDestDir()" style="padding: 8px 15px; font-size: 0.9em;">
                    ‚úì S√©lectionner ce dossier
                </button>
            </div>
            <div class="file-browser" id="destBrowser">
                <p>Chargement...</p>
            </div>
            <input type="text" id="destinationInput" placeholder="R√©pertoire de destination" value="{{ default_dest }}" style="margin-top: 10px;">
            <p style="margin-top: 10px; color: #6c757d; font-size: 0.9em;">
                üí° Naviguez dans les dossiers et cliquez sur "‚úì S√©lectionner ce dossier", ou modifiez le chemin directement. Le nom du fichier source sera utilis√© automatiquement.
            </p>
            <div id="finalPath" style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 5px; font-family: monospace; display: none;">
                <strong>Chemin final :</strong> <span id="finalPathText"></span>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" id="createBtn" onclick="createHardLink()">
                üîó Cr√©er le(s) Hard Link(s)
            </button>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        // D√©tection automatique du base path
        const basePath = window.location.pathname.replace(/\/$/, '');

        // D√©finir le lien vers les r√©glages dynamiquement
        document.getElementById('settingsLink').href = basePath + '/settings';

        let currentSourcePath = '/';
        let currentDestPath = '/';
        let selectedItems = []; // {path: string, type: 'file'|'directory', name: string}
        let selectedDestDir = '{{ default_dest }}';

        async function loadSourceDirectory(path) {
            try {
                const response = await fetch(`${basePath}/api/browse?path=${encodeURIComponent(path)}`);
                const items = await response.json();

                const browser = document.getElementById('sourceBrowser');
                browser.innerHTML = '';

                if (path !== '/') {
                    const parentItem = document.createElement('div');
                    parentItem.className = 'file-item';
                    parentItem.innerHTML = '<span class="file-icon">‚¨ÜÔ∏è</span> .. (Dossier parent)';
                    parentItem.onclick = () => {
                        const parentPath = path.split('/').slice(0, -1).join('/') || '/';
                        loadSourceDirectory(parentPath);
                    };
                    browser.appendChild(parentItem);
                }

                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'file-item';
                    itemDiv.style.display = 'flex';
                    itemDiv.style.alignItems = 'center';

                    const isSelected = selectedItems.some(s => s.path === item.path);
                    const icon = item.type === 'directory' ? 'üìÅ' : 'üìÑ';
                    const sizeInfo = item.size ? ` (${formatSize(item.size)})` : '';

                    itemDiv.innerHTML = `
                        <input type="checkbox" class="item-checkbox" data-path="${item.path}" data-type="${item.type}" data-name="${item.name}"
                            ${isSelected ? 'checked' : ''} style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                        <span class="file-icon">${icon}</span>
                        <span class="item-name">${item.name}${sizeInfo}</span>
                    `;

                    const checkbox = itemDiv.querySelector('.item-checkbox');
                    checkbox.onclick = (e) => {
                        e.stopPropagation();
                        toggleSelection(item.path, item.type, item.name, checkbox.checked);
                    };

                    // Double-clic pour entrer dans un dossier
                    itemDiv.ondblclick = () => {
                        if (item.type === 'directory') {
                            loadSourceDirectory(item.path);
                        }
                    };

                    // Simple clic pour cocher/d√©cocher
                    itemDiv.onclick = (e) => {
                        if (e.target.type !== 'checkbox') {
                            checkbox.checked = !checkbox.checked;
                            toggleSelection(item.path, item.type, item.name, checkbox.checked);
                        }
                    };

                    browser.appendChild(itemDiv);
                });

                currentSourcePath = path;
                document.getElementById('sourcePath').textContent = path;

            } catch (error) {
                console.error('Error loading source directory:', error);
                showMessage('Erreur lors du chargement du r√©pertoire', 'error');
            }
        }

        function toggleSelection(path, type, name, isSelected) {
            if (isSelected) {
                if (!selectedItems.some(s => s.path === path)) {
                    selectedItems.push({ path, type, name });
                }
            } else {
                selectedItems = selectedItems.filter(s => s.path !== path);
            }
            updateSelectionSummary();
        }

        function selectAllVisible() {
            const checkboxes = document.querySelectorAll('#sourceBrowser .item-checkbox');
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.checked = true;
                    toggleSelection(cb.dataset.path, cb.dataset.type, cb.dataset.name, true);
                }
            });
        }

        function clearSelection() {
            selectedItems = [];
            const checkboxes = document.querySelectorAll('#sourceBrowser .item-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectionSummary();
        }

        function updateSelectionSummary() {
            const summaryDiv = document.getElementById('selectionSummary');
            const countSpan = document.getElementById('selectionCount');
            const listDiv = document.getElementById('selectionList');

            if (selectedItems.length === 0) {
                summaryDiv.style.display = 'none';
                return;
            }

            summaryDiv.style.display = 'block';
            countSpan.textContent = selectedItems.length;

            const dirs = selectedItems.filter(s => s.type === 'directory');
            const files = selectedItems.filter(s => s.type === 'file');

            let html = '';
            if (dirs.length > 0) {
                html += `üìÅ ${dirs.length} dossier(s): ${dirs.map(d => d.name).join(', ')}<br>`;
            }
            if (files.length > 0) {
                html += `üìÑ ${files.length} fichier(s): ${files.map(f => f.name).join(', ')}`;
            }
            listDiv.innerHTML = html;
        }

        async function loadDestDirectory(path) {
            try {
                const response = await fetch(`${basePath}/api/browse?path=${encodeURIComponent(path)}`);
                const items = await response.json();

                const browser = document.getElementById('destBrowser');
                browser.innerHTML = '';

                if (path !== '/') {
                    const parentItem = document.createElement('div');
                    parentItem.className = 'file-item';
                    parentItem.innerHTML = '<span class="file-icon">‚¨ÜÔ∏è</span> .. (Dossier parent)';
                    parentItem.onclick = () => {
                        const parentPath = path.split('/').slice(0, -1).join('/') || '/';
                        loadDestDirectory(parentPath);
                    };
                    browser.appendChild(parentItem);
                }

                items.forEach(item => {
                    if (item.type === 'directory') {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'file-item';
                        itemDiv.innerHTML = `<span class="file-icon">üìÅ</span> ${item.name}`;

                        itemDiv.onclick = () => {
                            loadDestDirectory(item.path);
                        };

                        // Double click to select
                        itemDiv.ondblclick = () => {
                            selectDestDir(item.path);
                        };

                        browser.appendChild(itemDiv);
                    }
                });

                currentDestPath = path;
                document.getElementById('destPath').textContent = path;

            } catch (error) {
                console.error('Error loading dest directory:', error);
                showMessage('Erreur lors du chargement du r√©pertoire', 'error');
            }
        }

        function selectDestDir(path) {
            selectedDestDir = path;
            document.getElementById('destinationInput').value = path;
            updateFinalPath();
            showMessage(`üìÇ R√©pertoire de destination s√©lectionn√©: ${path}`, 'success');
        }

        function selectCurrentDestDir() {
            if (currentDestPath && currentDestPath !== '/') {
                selectDestDir(currentDestPath);
            } else {
                showMessage('‚ö†Ô∏è Veuillez naviguer vers un r√©pertoire valide', 'error');
            }
        }

        function updateFinalPath() {
            const finalPathEl = document.getElementById('finalPath');
            const finalPathText = document.getElementById('finalPathText');

            if (selectedItems.length > 0 && selectedDestDir) {
                finalPathText.textContent = `${selectedDestDir}/ (${selectedItems.length} √©l√©ment(s) s√©lectionn√©(s))`;
                finalPathEl.style.display = 'block';
            } else {
                finalPathEl.style.display = 'none';
            }
        }

        async function createHardLink() {
            const destDir = document.getElementById('destinationInput').value;

            if (selectedItems.length === 0) {
                showMessage('Veuillez s√©lectionner au moins un fichier ou dossier source', 'error');
                return;
            }

            if (!destDir) {
                showMessage('Veuillez s√©lectionner un r√©pertoire de destination', 'error');
                return;
            }

            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Cr√©ation en cours...';

            try {
                const response = await fetch(`${basePath}/api/create_hardlinks_batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: selectedItems,
                        dest_dir: destDir
                    })
                });

                const result = await response.json();

                if (result.total_created > 0 || result.total_skipped > 0) {
                    let msg = `‚úÖ ${result.total_created} hardlink(s) cr√©√©(s)`;
                    if (result.total_skipped > 0) {
                        msg += `, ${result.total_skipped} ignor√©(s)`;
                    }
                    if (result.total_errors > 0) {
                        msg += `, ${result.total_errors} erreur(s)`;
                    }
                    showMessage(msg, result.total_errors > 0 ? 'error' : 'success');

                    // Vider la s√©lection apr√®s succ√®s
                    if (result.total_errors === 0) {
                        clearSelection();
                    }
                } else if (result.error) {
                    showMessage(`‚ùå Erreur: ${result.error}`, 'error');
                } else {
                    showMessage('‚ö†Ô∏è Aucun fichier √† traiter', 'error');
                }

            } catch (error) {
                showMessage(`‚ùå Erreur: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîó Cr√©er le(s) Hard Link(s)';
            }
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';

            setTimeout(() => {
                msg.style.display = 'none';
            }, 5000);
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        // √âcouteur pour le champ de destination
        document.getElementById('destinationInput').addEventListener('input', function() {
            selectedDestDir = this.value;
            updateFinalPath();
        });

        // Load directories on page load
        loadSourceDirectory('/');
        loadDestDirectory('/');
    </script>
</body>
</html>
